# https://caddyserver.com/docs/caddyfile/directives/import
(schema-proxy) {
    handle {args[0]} {
        redir {http.request.uri}/ 301
    }

    handle_path {args[0]}/* {
        @auth_cookie {
            # Match requests with an access_token cookie but not an Authorization header
            header Cookie *access_token*
            not {
                header Authorization *
            }
        }

        reverse_proxy @auth_cookie postgrest:3000   {
            header_up Accept-Profile {args[1]}
            header_up Content-Profile {args[1]}
            header_up Authorization {http.request.cookie.access_token}
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Allow-Methods
        }

        reverse_proxy postgrest:3000   {
            header_up Accept-Profile {args[1]}
            header_up Content-Profile {args[1]}
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Allow-Methods
        }
    }
}

# Macrostrat.local domain is served by orbstack
localhost, macrostrat.local {
    tls internal

    # If request is from dev.macrostrat.local or macrostrat.local, allow credentials and set the origin
    # Match header origin to several values
    @local_origin {
        header Origin https://macrostrat.local
        header Origin https://dev.macrostrat.local
        header Origin http://localhost:3000
    }

    @external_origin {
        not header Origin https://macrostrat.local
        not header Origin https://dev.macrostrat.local
        not header Origin http://localhost:3000
    }

    @cors_preflight {
        method OPTIONS
    }

    header {
        Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    }

    header @external_origin {
        Access-Control-Allow-Origin *
    }

    header @local_origin {
        Access-Control-Allow-Origin "{http.request.header.Origin}"
        Access-Control-Allow-Credentials true
    }

    handle_path /api/v2/* {
        reverse_proxy api_v2:5000 {
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Allow-Methods
        }
    }

    handle_path /api/v3/* {
        reverse_proxy api_v3:80 {
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Allow-Methods
        }

        # Handle CORS preflight requests from here
        handle @cors_preflight {
            header Access-Control-Allow-Headers "Authorization, Content-Type"
            header Access-Control-Max-Age "86400"
            respond "" 204
         }
    }

    # APIs for macrostrat and map-ingestion
    # These use PostgREST as a proxy to the database and
    # have headers set to default to a specific schema
    import schema-proxy /api/v3/macrostrat/pg macrostrat_api
    import schema-proxy /api/v3/map-ingestion/pg map_ingestion_api

    # Legacy API for development
    import schema-proxy /api/pg macrostrat_api



    handle_path /tiles/* {
        reverse_proxy tileserver:8000 {
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Allow-Methods
        }
    }

    handle_path /cache/* {
        reverse_proxy map-cache:8000
    }

    handle_path /* {
        reverse_proxy web:3000
    }
}

dev.macrostrat.local {
    # Proxy to the locally running frontend application, if running
    tls internal
    reverse_proxy docker.host.internal:3000
}

offline.macrostrat.local {
    # An offline version of the frontend, if running
}

storage.macrostrat.local {
    tls internal
    reverse_proxy storage:9000
}

storage-ui.macrostrat.local {
    tls internal
    reverse_proxy storage:9001
}
