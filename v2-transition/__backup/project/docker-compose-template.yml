# *** header ***
#
# WARNING: You should not be editing this file under most circumstances.
# 
# This file has been auto-generated by install.pl. If you wish to override any of the
# attributes of the services and other entities defined here, you can do so by modifying
# docker-compose.override.yml. If you wish to change the set of services managed
# by this project, you should run either 'pbdb update project' or 'macrostrat update project'.
# You will be prompted to choose a project configuration, and this file will then be
# regenerated from the template stored in config/docker-compose-template.yml.
# 

version: "3.5"

services:
  
  # Frontend web server:
  # 
  nginx:
    build:
      context: frontend
      dockerfile: nginx/Dockerfile
    volumes:
      - type: bind
        source: ./certs
        target: /etc/nginx/ssl
      - type: bind
        source: ./logs/nginx/
        target: /var/log/nginx/
    ports:
      - "80:80"
      - "443:443"

# *** letsencrypt ***
services:
  nginx:
    volumes:
      - type: bind
        source: {{letsencrypt_path}}
        target: /etc/letsencrypt

# *** paleobiodb ***
services:
  nginx:
    volumes:
      - type: bind
        source: ./images
        target: /var/paleomacro/pbdb-main/build/img
      - type: bind
        source: ./archives
        target: /var/paleomacro/archives
      - type: volume
        source: ./taxa_downloads
        target: /var/paleomacro/classic/public/taxa_downloads
      - type: volume
        source: downloads
        target: /var/paleomacro/classic/public/downloads

services:
  
  # Main API:
  #  
  pbapi:
    build:
      context: frontend
      dockerfile: pbapi/Dockerfile
    volumes:
      - type: bind
        source: ./images
        target: /var/paleomacro/pbdb-main/build/img
      - type: bind
        source: ./archives
        target: /var/paleomacro/archives
      - type: bind
        source: ./logs/pbapi/
        target: /var/paleomacro/pbapi/logs
    ports:
      - "3000:3000"
      - "3003:3003"
      - "3999:3999"
  
  # Legacy web application for browsing and data entry
  # 
  classic:
    build:
      context: frontend
      dockerfile: classic/Dockerfile
    volumes:
      - type: bind
        source: ./logs/classic/
        target: /data/MyApp/logs
      - type: bind
        source: ./datalogs
        target: /data/MyApp/datalogs
    ports:
      - "6000:6000"
      - "6001:6001"
      - "6003:6003"

volumes:
  taxa_downloads:
  downloads:

# *** paleobiodb-dev ***
services:
  nginx:
    volumes:
      # Extra bind mounts for development
      - type: bind
        source: ./frontend/classic/public
        target: /var/paleomacro/classic/public
      - type: bind
        source: ./frontend/navigator
        target: /var/paleomacro/navigator
      - type: bind
        source: ./frontend/pbdb-main
        target: /var/paleomacro/pbdb-main
      - type: bind
        source: ./frontend/pbdb-app
        target: /var/paleomacro/pbdb-app
services:
  pbapi:
    volumes:
      # Extra bind mount for development
      - type: bind
        source: ./frontend/pbapi
        target: /var/paleomacro/pbapi
services:
  classic:
    volumes:
      # Extra bind mounts for development
      - type: bind
        source: ./frontend/classic/bin
        target: /data/MyApp/bin
      - type: bind
        source: ./frontend/classic/guest_templates
        target: /data/MyApp/guest_templates
      - type: bind
        source: ./frontend/classic/lib
        target: /data/MyApp/lib
      - type: bind
        source: ./frontend/pbapi/lib
        target: /data/MyApp/lib/PBData
      - type: bind
        source: ./frontend/pbdb-main
        target: /data/MyApp/pbdb-main
      - type: bind
        source: ./frontend/classic/public
        target: /data/MyApp/public
      - type: bind
        source: ./frontend/pbdb-app/
        target: /data/MyApp/resources
      - type: bind
        source: ./frontend/classic/templates
        target: /data/MyApp/templates
      - type: bind
        source: ./frontend/classic/var
        target: /data/MyApp/var
      - type: bind
        source: ./frontend/classic/views
        target: /data/MyApp/views

# *** earthlife ***
services:
  
  # Earthlife consortium API
  #
  earthlife:
    build:
      context: frontend
      dockerfile: earthlife/Dockerfile
    volumes:
      - type: bind
        source: ./logs/earthlife/
        target: /var/log/uwsgi
    ports:
      - "8008:8008"
      - "8003:8003"

# *** earthlife-dev ***
services:
  nginx:
    volumes:
      # Extra bind mount for development
      - type: bind
        source: ./frontend/earthlife
        target: /var/paleomacro/earthlife
services:
  earthlife:
    volumes:
      # Extra bind mount for development
      - type: bind
        source: ./frontend/earthlife
        target: /usr/src/app

# *** macrostrat ***
# *** macrostrat-dev ***
# *** mibasin ***
