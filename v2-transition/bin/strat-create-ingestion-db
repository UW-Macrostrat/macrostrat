#!/usr/bin/env bash
dbname="map_ingestion"

strat compose exec postgres createdb -Upostgres $dbname

# Create a map ingestion user with restricted permissions
strat compose exec postgres psql -Upostgres -c "CREATE USER map_ingestion WITH PASSWORD 'more-maps-for-macrostrat';"
strat compose exec postgres psql -Upostgres -c "GRANT CONNECT ON DATABASE $dbname TO map_ingestion;"
strat compose exec postgres psql -Upostgres -c "GRANT ALL PRIVILEGES ON SCHEMA sources TO map_ingestion;"

# Get an example dataset
POSTGRES_DB=$dbname

# Create the sources schema
strat compose exec postgres psql -Upostgres $dbname -c "CREATE SCHEMA sources;"

strat copy-data --table=maps.sources --table sources.az_mohave --table sources.az_mohave_lines

strat compose exec postgres psql -Upostgres $dbname -c "DELETE FROM maps.sources WHERE primary_table != 'az_mohave';"